---

- name: Install the openldap and required Packages
  apt: name={{ item }} state=installed update_cache=yes
  with_items: debian_ldap_pkgs
  environment: env

- name: Delete the configuration directory
  file: path=/etc/ldap/slapd.d state=absent

- name: Generate the root password for ldap
  shell: slappasswd -s {{ rootpw }}; touch /etc/ldap/pass_generated creates=/etc/openldap/pass_generated
  register: root_password

- name: Copy the slapd.conf configuration file
  template: src=slapd.conf_ubuntu.j2 dest=/etc/ldap/slapd.conf
  when: not root_password| skipped
  notify: restart slapd

- name: Copy the ldap.conf configuration file
  template: src=ldap.conf.j2 dest=/etc/ldap/ldap.conf

- name: Create the directory for ldap database
  file: path=/var/lib/ldap/{{ domain_name }}/ state=directory owner=openldap group=openldap

- name: Create the directory for ldap certificates
  file: path=/etc/ldap/certs/ state=directory owner=openldap group=openldap

- name: Generate the private key for certificate request
  shell: openssl genrsa -des3 -passout pass:password -out my1.key 1024 chdir=/etc/ldap/certs/ 
         creates=/etc/ldap/certs/my1.key

- name: Strip the passphrase from the key 
  shell: openssl rsa -in my1.key -passin pass:password -out my.key chdir=/etc/ldap/certs/ 
         creates=/etc/ldap/certs/my.key

- name: Create and sign the the new certificate 
  shell: openssl req -new -x509 -subj '/C={{ country }}/ST={{ state }}/L={{ location }}/O={{ organization }}/CN={{ ansible_hostname }}/' -days 3650 -key my.key -out cert.crt -extensions v3_ca chdir=/etc/ldap/certs/
         creates=/etc/ldap/certs/cert.crt

- name: copy the supporting files
  copy: src=slapd dest=/etc/default/slapd mode=0755
  when: enable_ssl

- name: start the slapd service
  service: name=slapd state=started enabled=yes 

- name: Copy the template for creating base dn
  template: src=domain.ldif dest=/tmp

- name: add the base domain
  shell: ldapadd -x -D "cn=Manager,dc={{ domain_name.split('.')[0] }},dc={{ domain_name.split('.')[1] }}" -w {{ rootpw }} -f /tmp/domain.ldif && touch /etc/ldap/rootdn_created creates=/etc/openldap/rootdn_created
   
